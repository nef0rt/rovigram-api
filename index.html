<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RoviGram ¬∑ –æ–±–ª–∞—á–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
  <style>
    /* ====== –°–¢–ò–õ–ò –¢–ï –ñ–ï, –ß–¢–û –ò –†–ê–ù–¨–®–ï ====== */
    /* –Ø –æ—Å—Ç–∞–≤–∏–ª –≤—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –æ—Ç–≤–µ—Ç */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at 30% 40%, #130b2b, #030014);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 12px #b38aff;
      opacity: 0.8;
      animation: fall linear infinite;
    }
    
    @keyframes fall {
      0% { transform: translateY(-10vh); opacity: 0.8; }
      100% { transform: translateY(110vh); opacity: 0.2; }
    }

    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      background: rgba(18, 12, 38, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 36px;
      position: relative;
      z-index: 10;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .screen {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .hidden {
      display: none !important;
    }

    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 24px;
    }

    .telegram-icon {
      width: 90px;
      height: 90px;
      background: linear-gradient(145deg, #2AABE4, #1A94D4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      box-shadow: 0 0 40px #2aabe4;
      font-size: 50px;
      color: white;
    }

    .app-title {
      font-size: 36px;
      font-weight: 800;
      color: white;
      margin-bottom: 8px;
      text-shadow: 0 0 15px #a47eff;
    }

    .glass-input {
      width: 100%;
      background: rgba(25, 18, 45, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 36px;
      padding: 18px 24px;
      color: white;
      font-size: 16px;
      margin-bottom: 16px;
    }
    
    .glass-input:focus {
      outline: none;
      border-color: #8b5cf6;
    }

    .glass-button {
      width: 100%;
      background: linear-gradient(145deg, #9d7aff, #6b3fd1);
      border: none;
      border-radius: 36px;
      padding: 18px;
      color: white;
      font-weight: 700;
      font-size: 18px;
      margin-top: 8px;
      cursor: pointer;
    }
    
    .glass-button.secondary {
      background: rgba(40, 30, 70, 0.7);
    }

    .auth-switch {
      margin-top: 20px;
      color: #aaa;
    }
    .auth-switch span {
      color: #8b5cf6;
      font-weight: 700;
      cursor: pointer;
    }

    .main-header {
      padding: 20px;
      background: rgba(15, 10, 30, 0.6);
      backdrop-filter: blur(25px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 40px;
      cursor: pointer;
      color: white;
    }

    .main-title {
      font-size: 22px;
      font-weight: 800;
      color: white;
    }

    .search-section {
      padding: 15px;
    }
    .search-box {
      display: flex;
      align-items: center;
      background: rgba(25, 18, 45, 0.6);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 30px;
      padding: 12px 20px;
    }
    .search-box input {
      background: transparent;
      border: none;
      color: white;
      width: 100%;
      margin-left: 10px;
    }
    .search-box input::placeholder {
      color: #aaa;
    }

    .search-results {
      padding: 0 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .search-item {
      background: rgba(25, 18, 45, 0.8);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 12px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .search-item button {
      background: #8b5cf6;
      border: none;
      border-radius: 20px;
      padding: 8px 15px;
      color: white;
      cursor: pointer;
    }

    .chats-list {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .chat-item {
      background: rgba(25, 18, 45, 0.6);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .chat-avatar {
      width: 50px;
      height: 50px;
      background: radial-gradient(circle at 30% 30%, #604a9e, #2f2352);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      margin-right: 16px;
    }
    .chat-info {
      flex: 1;
    }
    .chat-name {
      color: white;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .chat-last {
      color: rgba(220, 210, 255, 0.8);
      font-size: 13px;
    }

    .chat-screen {
      height: 100%;
      display: flex;
      flex-direction: column;
      background: rgba(10, 5, 20, 0.8);
    }
    .chat-header {
      padding: 15px;
      background: rgba(15, 10, 30, 0.6);
      backdrop-filter: blur(25px);
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .back-btn {
      font-size: 24px;
      color: white;
      cursor: pointer;
    }
    .messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 80%;
      padding: 12px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      color: white;
      align-self: flex-start;
    }
    .message.own {
      background: #6b3fd1;
      align-self: flex-end;
    }
    .message.system {
      background: rgba(255,255,255,0.05);
      align-self: center;
      font-style: italic;
      color: #aaa;
    }
    .message-input {
      display: flex;
      padding: 15px;
      gap: 10px;
      background: rgba(15, 10, 30, 0.6);
    }
    .message-input input {
      flex: 1;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 25px;
      color: white;
    }
    .message-input button {
      width: 50px;
      height: 50px;
      background: #6b3fd1;
      border: none;
      border-radius: 25px;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .fab {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #8b5cf6;
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 30px #8b5cf6;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-content {
      background: rgba(25, 18, 50, 0.9);
      backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 30px;
      padding: 25px;
      width: 90%;
      max-width: 350px;
      color: white;
    }
    .modal-options {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .option-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      text-align: center;
      cursor: pointer;
    }
    .option-btn.active {
      background: #8b5cf6;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: #1a1230;
      border: 1px solid #8b5cf6;
      border-radius: 15px;
      padding: 15px;
      color: white;
      text-align: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>

  <div class="app">
    <!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div id="authScreen" class="screen">
      <div class="auth-container">
        <div class="telegram-icon">‚úàÔ∏è</div>
        <div class="app-title">ROVIGRAM</div>
        <p style="color: #aaa; margin-bottom: 30px;">–æ–±–ª–∞—á–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
        <input type="text" id="nickname" class="glass-input" placeholder="–ù–∏–∫–Ω–µ–π–º (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)" 
               oninput="this.value = this.value.replace(/[^A-Za-z0-9]/g, '')">
        <input type="password" id="password" class="glass-input" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="glass-button" id="registerBtn">üì° –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="glass-button secondary" id="loginBtn">üöÄ –í–æ–π—Ç–∏</button>
        <div class="auth-switch">
          <span id="switchText">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</span>
        </div>
      </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù -->
    <div id="mainScreen" class="screen hidden">
      <div class="main-header">
        <div class="user-badge" id="userBadge" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –≤—ã—Ö–æ–¥–∞">
          <span>üë§</span> <span id="currentUser"></span>
        </div>
        <div class="main-title">ROVI</div>
        <div style="width: 60px;"></div>
      </div>
      <div class="search-section">
        <div class="search-box">
          <span>üîç</span>
          <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π...">
        </div>
      </div>
      <div id="searchResults" class="search-results"></div>
      <div class="chats-list" id="chatsList"></div>
      <div class="fab" id="fabBtn">+</div>
    </div>

    <!-- –≠–ö–†–ê–ù –ß–ê–¢–ê -->
    <div id="chatScreen" class="screen hidden">
      <div class="chat-screen">
        <div class="chat-header">
          <span class="back-btn" id="backBtn">‚Üê</span>
          <span id="chatWith" style="color: white; font-weight: 600;"></span>
        </div>
        <div class="messages" id="messages"></div>
        <div class="message-input">
          <input type="text" id="messageText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
          <button id="sendBtn">‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ê -->
  <div id="createModal" class="modal hidden">
    <div class="modal-content">
      <h3 style="margin-bottom:20px;">üìÅ –°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h3>
      <input type="text" id="chatName" class="glass-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <div class="modal-options">
        <div class="option-btn active" id="optionChannel">üì¢ –ö–∞–Ω–∞–ª</div>
        <div class="option-btn" id="optionGroup">üë• –ì—Ä—É–ø–ø–∞</div>
      </div>
      <button class="glass-button" id="createChatBtn">‚ú® –°–æ–∑–¥–∞—Ç—å</button>
      <button class="glass-button secondary" id="closeModalBtn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="notification" class="notification hidden"></div>

  <script>
    // ========== –¢–í–û–ô API –ù–ê RENDER ==========
    const API_URL = 'https://rovigram-api.onrender.com/api'; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø

    // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    let currentUser = null;
    let currentChat = null;
    let refreshInterval = null;

    // ========== –≠–õ–ï–ú–ï–ù–¢–´ ==========
    const authScreen = document.getElementById('authScreen');
    const mainScreen = document.getElementById('mainScreen');
    const chatScreen = document.getElementById('chatScreen');
    const nickname = document.getElementById('nickname');
    const password = document.getElementById('password');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const switchText = document.getElementById('switchText');
    const currentUserSpan = document.getElementById('currentUser');
    const userBadge = document.getElementById('userBadge');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const chatsList = document.getElementById('chatsList');
    const fabBtn = document.getElementById('fabBtn');
    const createModal = document.getElementById('createModal');
    const chatName = document.getElementById('chatName');
    const optionChannel = document.getElementById('optionChannel');
    const optionGroup = document.getElementById('optionGroup');
    const createChatBtn = document.getElementById('createChatBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const backBtn = document.getElementById('backBtn');
    const chatWith = document.getElementById('chatWith');
    const messagesDiv = document.getElementById('messages');
    const messageText = document.getElementById('messageText');
    const sendBtn = document.getElementById('sendBtn');
    const notification = document.getElementById('notification');

    // ========== –ó–í–ï–ó–î–´ ==========
    for (let i = 0; i < 50; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.width = (Math.random() * 3 + 1) + 'px';
      star.style.height = star.style.width;
      star.style.left = Math.random() * 100 + '%';
      star.style.animationDuration = Math.random() * 5 + 3 + 's';
      document.getElementById('stars').appendChild(star);
    }

    // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
    function showNotification(text, isError = false) {
      notification.textContent = text;
      notification.style.background = isError ? 'rgba(80, 30, 50, 0.95)' : '#1a1230';
      notification.classList.remove('hidden');
      setTimeout(() => notification.classList.add('hidden'), 3000);
    }

    // ========== API –ó–ê–ü–†–û–°–´ ==========
    async function apiRequest(endpoint, method = 'GET', body = null) {
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' }
        };
        
        if (body) {
          options.body = JSON.stringify(body);
        }
        
        const response = await fetch(`${API_URL}${endpoint}`, options);
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', true);
        return { error: 'connection_error' };
      }
    }

    // ========== –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
    function showMainScreen() {
      authScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      chatScreen.classList.add('hidden');
      loadChats();
    }

    function showChatScreen(chat) {
      currentChat = chat;
      chatWith.textContent = chat.name;
      authScreen.classList.add('hidden');
      mainScreen.classList.add('hidden');
      chatScreen.classList.remove('hidden');
      loadMessages();
      
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(loadMessages, 3000);
    }

    // ========== –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–û–í ==========
    async function loadChats() {
      if (!currentUser) return;
      
      const data = await apiRequest('/chats');
      const allChats = data.chats || [];
      
      if (allChats.length === 0) {
        chatsList.innerHTML = '<div style="color:#aaa;text-align:center;margin-top:50px;">‚ú® –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>';
        return;
      }
      
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞ –ø–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const chatsWithLastMsg = await Promise.all(allChats.map(async (chat) => {
        const msgData = await apiRequest(`/lastmessage/${chat.id}`);
        return { ...chat, lastMsg: msgData.message?.text || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π' };
      }));
      
      chatsList.innerHTML = chatsWithLastMsg.map(chat => {
        const avatar = chat.type === 'channel' ? 'üì¢' : chat.type === 'private' ? 'üë§' : 'üë•';
        
        return `<div class="chat-item" onclick="openChat('${chat.id}', '${chat.name}')">
          <div class="chat-avatar">${avatar}</div>
          <div class="chat-info">
            <div class="chat-name">${chat.name}</div>
            <div class="chat-last">${chat.lastMsg}</div>
          </div>
        </div>`;
      }).join('');
    }

    // ========== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
    async function loadMessages() {
      if (!currentChat || !currentUser) return;
      
      const data = await apiRequest(`/messages/${currentChat.id}`);
      const msgs = data.messages || [];
      
      messagesDiv.innerHTML = msgs.map(msg => 
        `<div class="message ${msg.sender === currentUser.username ? 'own' : ''}">
          <small style="opacity:0.7;">${msg.sender}</small><br>${msg.text}
        </div>`
      ).join('');
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    window.openChat = (chatId, chatName) => {
      openChatById(chatId, chatName);
    };

    async function openChatById(chatId, chatName) {
      const chat = { id: chatId, name: chatName };
      showChatScreen(chat);
    }

    // ========== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
    registerBtn.addEventListener('click', async () => {
      const nick = nickname.value.trim();
      const pass = password.value.trim();
      
      if (!nick || !pass) return showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è', true);
      if (!/^[A-Za-z0-9]+$/.test(nick)) return showNotification('‚ùå –¢–æ–ª—å–∫–æ –∞–Ω–≥–ª –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã', true);
      
      const data = await apiRequest('/register', 'POST', { username: nick, password: pass });
      
      if (data.success) {
        showNotification('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ');
        nickname.value = password.value = '';
      } else {
        showNotification(`‚ùå ${data.error || '–û—à–∏–±–∫–∞'}`, true);
      }
    });

    // ========== –í–•–û–î ==========
    loginBtn.addEventListener('click', async () => {
      const nick = nickname.value.trim();
      const pass = password.value.trim();
      
      if (!nick || !pass) return showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è', true);
      
      const data = await apiRequest('/login', 'POST', { username: nick, password: pass });
      
      if (data.success) {
        currentUser = data.user;
        currentUserSpan.textContent = data.user.username;
        showMainScreen();
        nickname.value = password.value = '';
        showNotification(`üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.username}`);
      } else {
        showNotification(`‚ùå ${data.error || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`, true);
      }
    });

    // ========== –í–´–•–û–î ==========
    userBadge.addEventListener('dblclick', () => {
      currentUser = null;
      if (refreshInterval) clearInterval(refreshInterval);
      authScreen.classList.remove('hidden');
      mainScreen.classList.add('hidden');
      chatScreen.classList.add('hidden');
    });

    // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –§–û–†–ú–´ ==========
    switchText.addEventListener('click', () => {
      if (registerBtn.style.display === 'none') {
        registerBtn.style.display = 'block';
        loginBtn.textContent = 'üöÄ –í–æ–π—Ç–∏';
        switchText.textContent = '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
      } else {
        registerBtn.style.display = 'none';
        loginBtn.textContent = 'üöÄ –í–æ–π—Ç–∏';
              switchText.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
      }
    });

    // ========== –ü–û–ò–°–ö –õ–Æ–î–ï–ô ==========
    searchInput.addEventListener('input', async () => {
      const query = searchInput.value.toLowerCase();
      if (!query) return searchResults.innerHTML = '';
      
      const data = await apiRequest(`/users?exclude=${currentUser?.username || ''}`);
      const users = data.users || [];
      const filtered = users.filter(u => u.username.includes(query));
      
      let html = '';
      filtered.forEach(u => html += `
        <div class="search-item">
          <span>üë§ ${u.username}</span>
          <button onclick="startPrivateChat('${u.username}')">–ù–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
      `);
      
      searchResults.innerHTML = html || '<div class="search-item">üî≠ –ù–∏—á–µ–≥–æ –Ω–µ—Ç</div>';
    });

    window.startPrivateChat = async (username) => {
      const chatId = [currentUser.username, username].sort().join('-');
      
      // –°–æ–∑–¥–∞—ë–º —á–∞—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      await apiRequest('/chats', 'POST', {
        id: chatId,
        name: username,
        type: 'private',
        createdBy: currentUser.username
      });
      
      openChatById(chatId, username);
      searchInput.value = '';
      searchResults.innerHTML = '';
    };

    // ========== FAB ==========
    fabBtn.addEventListener('click', () => createModal.classList.remove('hidden'));
    closeModalBtn.addEventListener('click', () => createModal.classList.add('hidden'));

    optionChannel.addEventListener('click', () => {
      optionChannel.classList.add('active');
      optionGroup.classList.remove('active');
    });
    optionGroup.addEventListener('click', () => {
      optionGroup.classList.add('active');
      optionChannel.classList.remove('active');
    });

    createChatBtn.addEventListener('click', async () => {
      const name = chatName.value.trim();
      if (!name) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', true);
      
      const type = optionChannel.classList.contains('active') ? 'channel' : 'group';
      const chatId = Date.now().toString();
      
      const data = await apiRequest('/chats', 'POST', {
        id: chatId,
        name,
        type,
        createdBy: currentUser.username
      });
      
      if (data.success) {
        createModal.classList.add('hidden');
        chatName.value = '';
        loadChats();
        showNotification(`‚úÖ ${type} "${name}" —Å–æ–∑–¥–∞–Ω`);
      }
    });

    // ========== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ==========
    sendBtn.addEventListener('click', async () => {
      const text = messageText.value.trim();
      if (!text || !currentChat || !currentUser) return;
      
      const data = await apiRequest('/messages', 'POST', {
        chatId: currentChat.id,
        sender: currentUser.username,
        text: text
      });
      
      if (data.success) {
        messageText.value = '';
        await loadMessages();
      }
    });

    messageText.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // ========== –ù–ê–ó–ê–î ==========
    backBtn.addEventListener('click', () => {
      if (refreshInterval) clearInterval(refreshInterval);
      currentChat = null;
      showMainScreen();
    });

    // ========== –ó–ê–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ö–ò ==========
    createModal.addEventListener('click', (e) => {
      if (e.target === createModal) createModal.classList.add('hidden');
    });

    window.alert = showNotification;
  </script>
</body>
</html>